<% content_for :title, "Parents" %>

<div class="page-header">
  <div>
    <h1 class="page-header__title">Parents</h1>
    <p class="page-header__subtitle">Manage parent accounts and linked children</p>
  </div>

  <div class="page-actions">
    <% if current_user.admin? %>
      <%= link_to "New Parent", new_parent_path, class: "btn btn-primary" %>
    <% end %>
  </div>
</div>

<div class="dashboard-split" style="margin-bottom:24px;">
  <div class="stat-card">
    <div class="stat-card__label">Total Parents</div>
    <div class="stat-card__value"><%= @parents.size %></div>
    <div class="stat-card__meta">Linked to Students: <%= @parents.select{|p| p.students_as_parent.any?}.size %></div>
  </div>
  
  <div class="stat-card">
    <div class="stat-card__label">Communication</div>
    <div class="text-frame" style="margin-top: 10px;">
      All parents have access to the Messaging module once registered.
    </div>
  </div>
</div>

<div class="card">
  <% if @parents.any? %>
    <div id="parents-table"></div>
  <% else %>
    <div class="text-frame" style="width:100%; text-align:center; padding: 40px;">
      <div style="font-weight: 800; font-size: 1.2rem; margin-bottom: 8px;">No Parents Found</div>
      <p class="form-help">Get started by creating a new parent account.</p>
      <% if current_user.admin? %>
        <%= link_to "Add Parent", new_parent_path, class: "btn btn-primary", style: "margin-top:14px" %>
      <% end %>
    </div>
  <% end %>
</div>

<script>
  (function() {
    function initParents() {
      const tableEl = document.getElementById("parents-table");
      if (!tableEl || tableEl.classList.contains("tabulator")) return;

      const data = [
        <% @parents.each do |p| %>
        {
          name: "<%= j p.name %>",
          email: "<%= j p.email %>",
          phone: "<%= j(p.phone.presence || 'â€”') %>",
          children: "<%= j p.students_as_parent.map(&:full_name).join(', ') %>",
          view_link: "<%= parent_path(p) %>",
          edit_link: "<%= current_user.admin? ? edit_parent_path(p) : '' %>"
        },
        <% end %>
      ];

      new Tabulator(tableEl, {
        data: data,
        layout: "fitColumns",
        pagination: "local",
        paginationSize: 15,
        columns: [
          { title: "Name", field: "name", widthGrow: 1.2 },
          { title: "Email", field: "email", widthGrow: 1.2 },
          { title: "Phone", field: "phone", width: 140 },
          { title: "Children", field: "children", widthGrow: 1.5, formatter: "textarea" },
          {
            title: "Actions", formatter: function(cell) {
              const d = cell.getData();
              let h = `<a href='${d.view_link}' class='btn btn-sm'>View</a>`;
              if(d.edit_link) h += ` <a href='${d.edit_link}' class='btn btn-sm btn-ghost'>Edit</a>`;
              return h;
            }
          }
        ]
      });
    }
    document.addEventListener("turbo:load", initParents);
  })();
</script>