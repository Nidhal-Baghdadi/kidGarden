<% content_for :title, "School Calendar" %>

<div class="page-header">
  <div>
    <h1 class="page-header__title">School Calendar</h1>
    <p class="page-header__subtitle">Curriculum and events in one place.</p>
  </div>
</div>

<!-- Main Calendar Frame -->
<div class="card" style="margin-bottom:24px; padding: 24px;">
  <div class="calendar">
    <div class="calendar__top">
      <div>
        <div class="calendar__month" id="current-month-year">Select a Month</div>
        <div class="text-frame" style="margin-top: 8px; font-size: 0.85rem;">
          Click an item to view details.
        </div>
      </div>

      <div class="calendar__controls">
        <button id="prev-month" class="btn btn-ghost" type="button">‹ Previous</button>
        <button id="next-month" class="btn btn-ghost" type="button">Next ›</button>
      </div>
    </div>

    <div id="calendar-grid" class="calendar__grid" aria-label="Calendar grid" style="min-height: 400px;">
      <!-- Grid will be rendered by JS -->
    </div>
  </div>
</div>

<!-- Lists Frame -->
<div class="dashboard-split">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <div style="font-weight:800; font-size:1.1rem;">Curriculum Schedule</div>
    </div>
    
    <% if @curriculums.any? %>
      <div id="curriculum-table"></div>
    <% else %>
      <div class="text-frame" style="width:100%;">No curriculum scheduled.</div>
    <% end %>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <div style="font-weight:800; font-size:1.1rem;">School Events</div>
    </div>
    
    <% if @events.any? %>
      <div id="events-list-table"></div>
    <% else %>
      <div class="text-frame" style="width:100%;">No events scheduled.</div>
    <% end %>
  </div>
</div>

<!-- Main Detail Modal -->
<div id="calendar-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="calendar-modal-title">
  <div class="modal__backdrop" data-modal-close="true"></div>
  <div class="modal__panel">
    <div class="modal__header">
      <div>
        <div class="modal__kicker" id="calendar-modal-type">Details</div>
        <h3 class="modal__title" id="calendar-modal-title">Item</h3>
      </div>
      <button class="icon-btn" type="button" aria-label="Close" data-modal-close="true">✕</button>
    </div>
    <div class="modal__body">
      <div class="modal__meta">
        <div class="modal__meta-row">
          <div class="modal__meta-label">Date</div>
          <div class="modal__meta-value" id="calendar-modal-date">—</div>
        </div>
        <div class="modal__meta-row">
          <div class="modal__meta-label">Time</div>
          <div class="modal__meta-value" id="calendar-modal-time">—</div>
        </div>
      </div>
      <div class="modal__desc">
        <div class="modal__meta-label">Description</div>
        <div class="readonly" id="calendar-modal-desc" style="height:auto; min-height:80px; padding:12px; align-items:flex-start; margin-top:8px;">
          —
        </div>
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn btn-ghost" type="button" data-modal-close="true">Close</button>
    </div>
  </div>
</div>

<!-- Day Expanded List Modal -->
<div id="day-list-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal__backdrop" data-modal-close="true"></div>
  <div class="modal__panel">
    <div class="modal__header">
      <div>
        <div class="modal__kicker">Schedule for</div>
        <h3 class="modal__title" id="day-modal-title">Date</h3>
      </div>
      <button class="icon-btn" type="button" aria-label="Close" data-modal-close="true">✕</button>
    </div>
    <div class="modal__body" id="day-modal-body" style="display:flex; flex-direction:column; gap:10px;">
      <!-- Content injected by JS -->
    </div>
    <div class="modal__footer">
      <button class="btn btn-ghost" type="button" data-modal-close="true">Close</button>
    </div>
  </div>
</div>

<script>
  (function() {
    let currentViewDate = new Date();
    currentViewDate.setDate(1);

    function initCalendar() {
      const grid = document.getElementById("calendar-grid");
      const monthHeader = document.getElementById("current-month-year");
      if (!grid || !monthHeader) return;

      const events = [
        <% @calendar_events.each do |e| %>
          {
            title: "<%= j e[:title] %>",
            start: new Date("<%= e[:start]&.iso8601 %>"),
            end: new Date("<%= e[:end]&.iso8601 %>"),
            type: "<%= e[:type] %>",
            description: "<%= j e[:description].to_s %>"
          },
        <% end %>
      ].filter(e => !isNaN(e.start.getTime()));

      function render() {
        grid.innerHTML = "";
        const year = currentViewDate.getFullYear();
        const month = currentViewDate.getMonth();
        
        monthHeader.textContent = currentViewDate.toLocaleString('default', { month: 'long', year: 'numeric' });

        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        days.forEach(d => {
          const h = document.createElement("div");
          h.className = "cal-head";
          h.textContent = d;
          grid.appendChild(h);
        });

        const firstDay = new Date(year, month, 1).getDay();
        const lastDay = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
          const e = document.createElement("div");
          e.className = "cal-day is-empty";
          grid.appendChild(e);
        }

        const now = new Date();
        for (let d = 1; d <= lastDay; d++) {
          const cell = document.createElement("div");
          cell.className = "cal-day";
          if (year === now.getFullYear() && month === now.getMonth() && d === now.getDate()) cell.classList.add("is-today");

          const num = document.createElement("div");
          num.className = "cal-day__num";
          num.textContent = d;
          cell.appendChild(num);

          const list = document.createElement("div");
          list.className = "cal-events";
          
          const dayEvents = events.filter(e => 
            e.start.getFullYear() === year && 
            e.start.getMonth() === month && 
            e.start.getDate() === d
          );
          
          dayEvents.slice(0, 3).forEach(e => {
            const p = document.createElement("div");
            p.className = `cal-pill cal-pill--${e.type}`;
            p.textContent = e.title;
            p.onclick = (ev) => { ev.stopPropagation(); showDetailModal(e); };
            list.appendChild(p);
          });

          if (dayEvents.length > 3) {
            const more = document.createElement("div");
            more.className = "cal-more";
            more.textContent = `+${dayEvents.length - 3} more`;
            more.onclick = (ev) => { ev.stopPropagation(); showDayModal(dayEvents, new Date(year, month, d)); };
            list.appendChild(more);
          }

          cell.appendChild(list);
          grid.appendChild(cell);
        }
      }

      function showDetailModal(e) {
        const m = document.getElementById("calendar-modal");
        if (!m) return;
        document.getElementById("calendar-modal-title").textContent = e.title;
        document.getElementById("calendar-modal-type").textContent = e.type.toUpperCase();
        document.getElementById("calendar-modal-date").textContent = e.start.toLocaleDateString();
        document.getElementById("calendar-modal-time").textContent = e.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        document.getElementById("calendar-modal-desc").textContent = e.description || "No description provided.";
        m.classList.add("is-open");
      }

      function showDayModal(dayEvents, date) {
        const m = document.getElementById("day-list-modal");
        if (!m) return;
        document.getElementById("day-modal-title").textContent = date.toLocaleDateString('default', { month: 'long', day: 'numeric', year: 'numeric' });
        const body = document.getElementById("day-modal-body");
        body.innerHTML = "";
        
        dayEvents.forEach(e => {
          const item = document.createElement("div");
          item.className = `cal-pill cal-pill--${e.type}`;
          item.style.fontSize = "0.9rem";
          item.style.padding = "10px 14px";
          item.style.whiteSpace = "normal";
          item.innerHTML = `<strong>${e.title}</strong><br><span style="font-size:0.75rem; opacity:0.8">${e.start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>`;
          item.onclick = () => { m.classList.remove("is-open"); showDetailModal(e); };
          body.appendChild(item);
        });
        
        m.classList.add("is-open");
      }

      document.querySelectorAll("[data-modal-close]").forEach(b => b.onclick = () => {
        const detailModal = document.getElementById("calendar-modal");
        const dayModal = document.getElementById("day-list-modal");
        if (detailModal) detailModal.classList.remove("is-open");
        if (dayModal) dayModal.classList.remove("is-open");
      });

      const pBtn = document.getElementById("prev-month");
      const nBtn = document.getElementById("next-month");
      if (pBtn) {
        pBtn.onclick = () => {
          currentViewDate.setMonth(currentViewDate.getMonth() - 1);
          render();
        };
      }
      if (nBtn) {
        nBtn.onclick = () => {
          currentViewDate.setMonth(currentViewDate.getMonth() + 1);
          render();
        };
      }

      render();

      // --- Tabulator Lists ---
      const currEl = document.getElementById("curriculum-table");
      if (currEl && !currEl.classList.contains("tabulator")) {
        new Tabulator(currEl, {
          data: [<% @curriculums.each do |c| %> {subject: "<%= j c.subject %>", title: "<%= j c.title %>", time: "<%= c.start_time.strftime('%b %d, %H:%M') %>"}, <% end %>],
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 5,
          columns: [
            {title: "Subject", field: "subject", width: 100},
            {title: "Title", field: "title", widthGrow: 2},
            {title: "Time", field: "time", width: 120}
          ]
        });
      }

      const evEl = document.getElementById("events-list-table");
      if (evEl && !evEl.classList.contains("tabulator")) {
        new Tabulator(evEl, {
          data: [<% @events.each do |e| %> {title: "<%= j e.title %>", time: "<%= e.start_time.strftime('%b %d, %H:%M') %>", loc: "<%= j e.location %>"}, <% end %>],
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 5,
          columns: [
            {title: "Event", field: "title", widthGrow: 2},
            {title: "Location", field: "loc"},
            {title: "Time", field: "time", width: 120}
          ]
        });
      }
    }

    document.addEventListener("turbo:load", initCalendar);
    // Safety check for direct page loads
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initCalendar);
    } else {
      initCalendar();
    }
  })();
</script>
