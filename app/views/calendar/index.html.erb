<% content_for :title, "Calendar" %>

<div class="d-flex justify-between items-center mb-4">
  <h1>School Calendar</h1>
</div>

<div class="card">
  <h3>Calendar View</h3>
  <div id="calendar-container">
    <div class="calendar-controls mb-4">
      <button id="prev-month" class="btn btn-outline">‹ Prev</button>
      <span id="current-month-year" class="mx-4 text-lg font-semibold"></span>
      <button id="next-month" class="btn btn-outline">Next ›</button>
    </div>
    <div id="calendar-grid" class="calendar-grid"></div>
  </div>
</div>

<div class="grid grid-cols-2 mb-4">
  <div class="card">
    <h3>Curriculum Schedule</h3>
    <% if @curriculums.any? %>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Subject</th>
              <th>Title</th>
              <th>Date & Time</th>
              <th>Classroom</th>
            </tr>
          </thead>
          <tbody>
            <% @curriculums.each do |curriculum| %>
              <tr>
                <td><%= curriculum.subject %></td>
                <td><%= curriculum.title %></td>
                <td>
                  <%= curriculum.start_time.strftime("%b %d, %Y") %><br>
                  <%= curriculum.start_time.strftime("%I:%M %p") %> - <%= curriculum.end_time.strftime("%I:%M %p") %>
                </td>
                <td><%= curriculum.classroom&.name || "N/A" %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p>No curriculum scheduled.</p>
    <% end %>
  </div>

  <div class="card">
    <h3>School Events</h3>
    <% if @events.any? %>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Event</th>
              <th>Date & Time</th>
              <th>Location</th>
            </tr>
          </thead>
          <tbody>
            <% @events.each do |event| %>
              <tr>
                <td><%= event.title %></td>
                <td>
                  <%= event.start_time.strftime("%b %d, %Y") %><br>
                  <%= event.start_time.strftime("%I:%M %p") %> - <%= event.end_time.strftime("%I:%M %p") %>
                </td>
                <td><%= event.location %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p>No events scheduled.</p>
    <% end %>
  </div>
</div>

<style>
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background-color: var(--border);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .calendar-header {
    background-color: var(--primary);
    color: var(--primary-foreground);
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
  }

  .calendar-day {
    background-color: var(--card);
    min-height: 100px;
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    max-height: 135px;
  }

  .day-number {
    padding: 0.5rem;
    font-weight: 600;
    text-align: right;
  }

  .day-events {
    flex: 1;
    padding: 0.25rem;
    overflow-y: auto;
    font-size: 0.75rem;
  }

  .calendar-event {
    padding: 0.25rem;
    margin: 0.1rem 0;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
  }

  .curriculum-event {
    background: linear-gradient(135deg, var(--secondary), color-mix(in oklab, var(--secondary) 80%, white));
    color: var(--secondary-foreground);
    border-left: 3px solid var(--secondary);
  }

  .event-event {
    background: linear-gradient(135deg, var(--accent), color-mix(in oklab, var(--accent) 80%, white));
    color: var(--accent-foreground);
    border-left: 3px solid var(--accent);
  }

  .today {
    background-color: var(--accent) !important;
  }

  .today .day-number {
    background: var(--primary);
    color: var(--primary-foreground);
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    margin-left: auto;
    margin-right: 0.25rem;
  }

  .calendar-controls {
    display: flex;
    justify-content: center;
    align-items: center;
  }
</style>

<script>
  // Ensure calendar initializes after all DOM content is loaded
  document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
  });

  // Also try to initialize after a slight delay to handle navigation cases
  window.addEventListener('load', function() {
    setTimeout(initializeCalendar, 100);
  });

  // Initialize when Turbolinks renders a page (for SPAs)
  document.addEventListener('turbolinks:load', function() {
    initializeCalendar();
  });

  // For compatibility with Turbo (Rails 7+)
  document.addEventListener('turbo:load', function() {
    initializeCalendar();
  });

  function initializeCalendar() {
    // Prevent multiple initializations
    if (window.calendarInitialized) {
      return;
    }

    // Calendar state
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();

    // DOM elements
    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonthYear = document.getElementById('current-month-year');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');

    // Only proceed if elements exist
    if (!calendarGrid || !currentMonthYear || !prevMonthBtn || !nextMonthBtn) {
      return;
    }

    // Days of the week
    const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    // Format calendar events from server data
    const calendarEvents = [
      <% @calendar_events.each_with_index do |event, index| %>
        {
          id: '<%= "event_#{event[:type]}_#{index}" %>',
          title: '<%= j event[:title] %>',
          start: new Date('<%= event[:start].iso8601 %>'),
          end: new Date('<%= event[:end].iso8601 %>'),
          type: '<%= event[:type] %>',
          description: '<%= j event[:description] || '' %>'
        }<%= index < @calendar_events.length - 1 ? ',' : '' %>
      <% end %>
    ];

    // Render the calendar
    function renderCalendar() {
      // Clear the calendar grid
      calendarGrid.innerHTML = '';

      // Update the month/year display
      const monthNames = ["January", "February", "March", "April", "May", "June",
                         "July", "August", "September", "October", "November", "December"];
      currentMonthYear.textContent = `${monthNames[currentMonth]} ${currentYear}`;

      // Add day headers
      daysOfWeek.forEach(day => {
        const headerCell = document.createElement('div');
        headerCell.className = 'calendar-header';
        headerCell.textContent = day;
        calendarGrid.appendChild(headerCell);
      });

      // Get the first day of the month and the number of days in the month
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      // Add empty cells for days before the first day of the month
      for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-day';
        calendarGrid.appendChild(emptyCell);
      }

      // Add cells for each day of the month
      const today = new Date();
      for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';

        // Check if this day is today
        if (currentYear === today.getFullYear() &&
            currentMonth === today.getMonth() &&
            day === today.getDate()) {
          dayCell.classList.add('today');
        }

        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        dayCell.appendChild(dayNumber);

        const dayEventsContainer = document.createElement('div');
        dayEventsContainer.className = 'day-events';

        // Find events for this day
        const dayEvents = calendarEvents.filter(event => {
          const eventDate = event.start;
          return eventDate.getFullYear() === currentYear &&
                 eventDate.getMonth() === currentMonth &&
                 eventDate.getDate() === day;
        });

        // Add events to the day
        dayEvents.forEach(event => {
          const eventElement = document.createElement('div');
          eventElement.className = `calendar-event ${event.type}-event`;
          eventElement.textContent = event.title;
          eventElement.title = `${event.title}\n${event.start.toLocaleTimeString()} - ${event.end.toLocaleTimeString()}\n${event.description}`;

          // Add click event to show details
          eventElement.addEventListener('click', () => {
            const details =
              '<strong>' + event.title + '</strong><br>' +
              'Type: ' + event.type + '<br>' +
              'Date: ' + event.start.toLocaleDateString() + '<br>' +
              'Time: ' + event.start.toLocaleTimeString() + ' - ' + event.end.toLocaleTimeString() + '<br>' +
              'Description: ' + (event.description || 'No description');

            alert(details);
          });

          dayEventsContainer.appendChild(eventElement);
        });

        dayCell.appendChild(dayEventsContainer);
        calendarGrid.appendChild(dayCell);
      }
    }

    // Navigation
    prevMonthBtn.addEventListener('click', function(e) {
      e.preventDefault();
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
    });

    nextMonthBtn.addEventListener('click', function(e) {
      e.preventDefault();
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    });

    // Initial render
    renderCalendar();

    // Mark as initialized to prevent multiple initializations
    window.calendarInitialized = true;
  }
</script>
