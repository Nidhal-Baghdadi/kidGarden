<% content_for :title, "Student Parents/Guardians" %>

<div class="page-header">
  <div>
    <h1 class="page-header__title">Parents / Guardians</h1>
    <p class="page-header__subtitle"><%= @student.first_name %> <%= @student.last_name %></p>
  </div>

  <div class="page-actions">
    <%= link_to "Back to Student", @student, class: "btn" %>
  </div>
</div>

<div class="card" style="margin-bottom:14px;">
  <h3 style="margin:0 0 12px 0;">Add Parent / Guardian</h3>

  <%= form_with model: @relationship, url: { controller: 'parent_student_relationships', action: 'create' }, local: true do |form| %>
    <%= form.hidden_field :student_id, value: @student.id %>

    <div class="form-grid">
      <div class="form-group">
        <%= form.label :parent_id, "Parent/Guardian", class: "form-label" %>
        <%= form.select :parent_id, User.where(role: 'parent').map { |u| [u.name, u.id] }, { prompt: "Select parent" }, { class: "form-control" } %>
      </div>

      <div class="form-group">
        <%= form.label :relationship_type, "Relationship type", class: "form-label" %>
        <%= form.select :relationship_type, ParentStudentRelationship.relationship_types.keys.map { |k| [k.humanize, k] }, { prompt: "Select relationship" }, { class: "form-control" } %>
      </div>
    </div>

    <div class="page-actions" style="justify-content:flex-end; margin-top: 10px;">
      <%= form.submit "Add", class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<div class="card">
  <h3 style="margin:0 0 12px 0;">Current Parents / Guardians</h3>

  <% if @student.parent_student_relationships.any? %>
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Parent name</th>
            <th>Relationship</th>
            <th>Priority</th>
            <th>Active</th>
            <th class="no-sort">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @student.parent_student_relationships.includes(:parent).each do |rel| %>
            <tr>
              <td><%= rel.parent.name %></td>
              <td><%= rel.relationship_type.humanize %></td>
              <td><%= rel.contact_priority || "â€”" %></td>
              <td><%= rel.active? ? "Yes" : "No" %></td>
              <td>
                <%= link_to "Remove", rel, method: :delete, class: "btn btn-ghost btn-sm",
                            data: { confirm: "Remove this relationship?" } %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="form-help">No parent/guardian relationships found.</div>
  <% end %>
</div>
