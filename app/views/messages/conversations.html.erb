<% content_for :title, "Messages" %>

<div class="page-header">
  <div>
    <h1 class="page-header__title">Messages</h1>
    <p class="page-header__subtitle">Your conversations with parents, teachers, and staff.</p>
  </div>

  <div class="page-actions">
    <%= link_to "New Message", new_user_conversation_path, class: "btn btn-primary" %>
  </div>
</div>

<div class="card">
  <% if @conversations.any? %>
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>With</th>
            <th>Last message</th>
            <th>Date</th>
            <th>Unread</th>
            <th class="no-sort">Actions</th>
          </tr>
        </thead>

        <tbody>
          <% @conversations.each do |conversation| %>
            <% other  = conversation.other_participant(current_user) %>
            <% last   = conversation.last_message %>
            <% unread = @unread_counts[conversation.id].to_i %>

            <tr>
              <td>
                <div style="font-weight:700;"><%= other&.name || "Unknown" %></div>
                <div class="form-help" style="margin:4px 0 0 0;">
                  <%= conversation.subject.presence || "Conversation" %>
                </div>
              </td>

              <td>
                <% if last %>
                  <div style="max-width:520px;">
                    <%= last.content.to_s.truncate(80) %>
                  </div>
                  <div class="form-help" style="margin:4px 0 0 0;">
                    <%= time_ago_in_words(last.created_at) %> ago
                  </div>
                <% else %>
                  <span class="form-help">No messages yet</span>
                <% end %>
              </td>

              <td>
                <%= last ? last.created_at.strftime("%b %d, %Y") : "—" %>
              </td>

              <td>
                <% if unread > 0 %>
                  <span class="status-badge status-warning"><%= unread %> new</span>
                <% else %>
                  <span class="form-help">—</span>
                <% end %>
              </td>

              <td>
                <%= link_to "Open", conversation_messages_path(conversation), class: "btn btn-sm" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="form-help">No conversations yet.</div>
    <div style="margin-top:12px;">
      <%= link_to "Start New Conversation", new_user_conversation_path, class: "btn btn-primary" %>
    </div>
  <% end %>
</div>
