<% content_for :title, "Messages" %>
<% other = @conversation.other_participant(current_user) %>

<div class="messaging-shell">
  <!-- Sidebar -->
  <aside class="messaging-sidebar">
    <div class="messaging-sidebar__header">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0; font-size:1.2rem; font-weight:800;">Chats</h2>
        <%= link_to "+", new_user_conversation_path, class: "icon-btn", title: "New Chat" %>
      </div>
    </div>
    
    <%= render 'conversation_list', conversations: @conversations, unread_counts: @unread_counts, current_conversation: @conversation %>
  </aside>

  <!-- Main Chat -->
  <main class="messaging-main">
    <header class="messaging-main__header">
      <div style="display:flex; align-items:center; gap:12px;">
        <div class="chat-item__avatar" style="height:40px; width:40px; flex:0 0 40px; font-size:1rem;">
          <%= other&.name&.first&.upcase || "?" %>
        </div>
        <div>
          <div style="font-weight:800; line-height:1.2;"><%= other&.name || "Unknown" %></div>
          <div style="font-size:0.75rem; color:var(--primary); font-weight:700;">Online</div>
        </div>
      </div>
      
      <div class="messaging-main__actions">
        <%= link_to user_conversations_path, class: "icon-btn", title: "Close" do %>
          ✕
        <% end %>
      </div>
    </header>

    <div id="messages-container" class="messaging-main__messages">
      <% @messages.each do |message| %>
        <% mine = (message.sender_id == current_user.id) %>
        <div class="message-bubble <%= mine ? 'message-bubble--mine' : 'message-bubble--theirs' %>">
          <div class="message-bubble__content">
            <%= simple_format(message.content) %>
            
            <% if message.attachments.attached? %>
              <div class="msg__attachments" style="margin-top:8px;">
                <% message.attachments.each do |file| %>
                  <%= link_to file.filename.to_s, url_for(file), class: "btn btn-sm", style: "background:rgba(255,255,255,0.2); border:none; color:inherit;", target: "_blank" %>
                <% end %>
              </div>
            <% end %>
          </div>
          <div class="message-bubble__meta">
            <%= message.created_at.strftime("%I:%M %p") %>
            <% if mine %>
              <span title="Status">• Sent</span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="messaging-main__composer">
      <%= form_with model: @message, url: conversation_messages_path(@conversation), local: true, class: "chat-composer" do |form| %>
        <%= form.text_area :content, placeholder: "Type a message...", class: "chat-composer__input", rows: 1 %>
        <%= form.submit "Send", class: "btn btn-primary" %>
      <% end %>
    </div>
  </main>
</div>

<script>
  (function() {
    function scrollToBottom() {
      const container = document.getElementById("messages-container");
      if (container) {
        container.scrollTop = container.scrollHeight;
      }
    }

    document.addEventListener("turbo:load", scrollToBottom);
    
    // Auto-expand textarea
    const tx = document.querySelector(".chat-composer__input");
    if (tx) {
      tx.addEventListener("input", function() {
        this.style.height = "auto";
        this.style.height = (this.scrollHeight) + "px";
      });
    }
  })();
</script>