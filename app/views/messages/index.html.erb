<% content_for :title, "Messages" %>
<% other = @conversation.other_participant(current_user) %>

<div class="page-header">
  <div>
    <h1 class="page-header__title"><%= @conversation.subject.presence || "Conversation" %></h1>
    <p class="page-header__subtitle">With <%= other&.name || "Unknown" %></p>
  </div>

  <div class="page-actions">
    <%= link_to "Back", user_conversations_path, class: "btn" %>
  </div>
</div>

<div class="card" style="padding:0;" data-conversation-id="<%= @conversation.id %>">
  <div id="messages-container" class="messages-thread" data-autoscroll="true">
    <% @messages.each do |message| %>
      <% mine = (message.sender_id == current_user.id) %>
      <% read_at_for_other = mine && other ? message.read_status_for_user(other) : nil %>

      <div class="msg <%= mine ? "msg--mine" : "msg--theirs" %>">
        <div class="msg__meta">
          <span class="msg__name"><%= message.sender&.name || "Unknown" %></span>
          <span class="msg__time"><%= message.created_at.strftime("%I:%M %p") %></span>

          <% if mine %>
            <span class="msg__status">
              • <%= read_at_for_other.present? ? "Read" : "Sent" %>
            </span>
          <% end %>
        </div>

        <div class="msg__bubble">
          <%= simple_format(message.content) %>

          <% if message.attachments.attached? %>
            <div class="msg__attachments">
              <% message.attachments.each do |file| %>
                <%= link_to file.filename.to_s, url_for(file), class: "msg__file", target: "_blank", rel: "noopener" %>
              <% end %>
            </div>
          <% end %>

          <% if mine || current_user.admin? %>
            <div class="msg__actions">
              <%= link_to "Delete",
                    message,
                    data: { turbo_method: :delete, turbo_confirm: "Delete this message?" },
                    class: "msg__delete" %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="composer">
    <% if @message.errors.any? %>
      <div class="alert alert--error" style="margin:0 0 12px 0;">
        <strong><%= pluralize(@message.errors.count, "error") %> prevented sending:</strong>
        <ul style="margin:8px 0 0 18px;">
          <% @message.errors.full_messages.each do |m| %>
            <li><%= m %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%= form_with model: @message, url: conversation_messages_path(@conversation), local: true do |form| %>
      <div class="composer__grid">
        <div class="form-group" style="margin:0;">
          <%= form.label :content, "Message", class: "form-label" %>
          <%= form.text_area :content, placeholder: "Type your message…", class: "form-control", rows: 2 %>

          <div style="margin-top:10px;">
            <%= form.label :attachments, "Attachments", class: "form-label" %>
            <%= form.file_field :attachments, multiple: true, class: "form-control" %>
            <div class="form-help" style="margin-top:6px;">
              You can attach multiple files.
            </div>
          </div>
        </div>

        <div class="composer__actions">
          <%= form.submit "Send", class: "btn btn-primary" %>
          <%= link_to "Cancel", user_conversations_path, class: "btn btn-ghost" %>
        </div>
      </div>
    <% end %>
  </div>
</div>
