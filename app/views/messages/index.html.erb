<% content_for :title, "Messages" %>

<div class="d-flex justify-between items-center mb-4">
  <div>
    <h1><%= @conversation.subject %></h1>
    <p class="text-sm text-gray-500 mt-1">With <%= @conversation.other_participant(current_user)&.name %></p>
  </div>
  <%= link_to "Back to Conversations", user_conversations_path, class: "btn btn-outline" %>
</div>

<div class="card" style="min-height: 500px;">
  <div id="messages-container" class="p-4" style="height: 400px; overflow-y: auto;">
    <% @messages.each do |message| %>
      <div class="message-bubble <%= message.sender == current_user ? 'sender-message' : 'recipient-message' %> mb-4">
        <div class="message-header d-flex items-center mb-1">
          <span class="font-medium"><%= message.sender.name %></span>
          <span class="text-xs text-gray-500 ml-2"><%= message.created_at.strftime("%I:%M %p") %></span>
          <% if message.sender == current_user %>
            <span class="text-xs text-gray-500 ml-2">
              <% if message.read_at %>
                <i class="fas fa-check-double text-blue-500"></i> Read
              <% else %>
                <i class="fas fa-check"></i> Sent
              <% end %>
            </span>
          <% end %>
        </div>
        <div class="message-content p-3 rounded-lg max-w-[70%] <%= message.sender == current_user ? 'bg-primary text-primary-foreground ml-auto' : 'bg-gray-100 text-gray-800' %>">
          <%= simple_format(message.content) %>
          <% if message.sender == current_user %>
            <div class="text-xs mt-1 text-right">
              <%= link_to "Delete", message,
                          data: {
                            turbo_method: :delete,
                            turbo_confirm: "Are you sure you want to delete this message?"
                          },
                          class: "text-red-500 hover:text-red-700" %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="message-form-container p-4 border-t">
    <%= form_with model: @message, url: conversation_messages_path(@conversation), method: :post, local: true, class: "d-flex" do |form| %>
      <div class="flex-grow mr-2">
        <%= form.text_area :content, placeholder: "Type your message...", class: "form-control", rows: 2 %>
      </div>
      <div class="d-flex flex-col">
        <%= form.submit "Send", class: "btn btn-primary mb-2" %>
        <%= link_to "Cancel", user_conversations_path, class: "btn btn-outline" %>
      </div>
    <% end %>
  </div>
</div>

<style>
  .sender-message {
    text-align: right;
  }

  .recipient-message {
    text-align: left;
  }

  .message-bubble {
    max-width: 80%;
  }

  .sender-message .message-content {
    background-color: var(--primary);
    color: var(--primary-foreground);
    border-bottom-right-radius: 0 !important;
  }

  .recipient-message .message-content {
    background-color: var(--secondary);
    color: var(--secondary-foreground);
    border-bottom-left-radius: 0 !important;
  }

  #messages-container {
    display: flex;
    flex-direction: column;
  }

  .message-form-container {
    background-color: var(--card);
  }
</style>