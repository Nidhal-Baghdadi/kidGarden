<% content_for :title, "Photo Gallery" %>

<div class="d-flex justify-between items-center mb-4">
  <h1>Photo Gallery</h1>
  <% if current_user.teacher? || current_user.admin? %>
    <%= link_to "Upload Photo", new_photo_path, class: "btn btn-primary" %>
  <% end %>
</div>

<!-- Filters -->
<div class="card mb-4">
  <%= form_with url: photos_path, method: :get, local: true, class: "form" do |form| %>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <% if current_user.teacher? || current_user.admin? %>
        <div class="form-group">
          <%= form.label :student_id, "Student", class: "form-label" %>
          <%= form.select :student_id,
                          options_from_collection_for_select(@accessible_students, :id, :full_name, params[:student_id]),
                          { prompt: "All Students" },
                          { class: "form-control" } %>
        </div>
      <% end %>

      <div class="form-group">
        <%= form.label :category, "Category", class: "form-label" %>
        <%= form.select :category,
                        options_for_select([
                          ['All Categories', ''],
                          ['Activities', 'activity'],
                          ['Events', 'event'],
                          ['Milestones', 'milestone'],
                          ['Daily Life', 'daily_life']
                        ], params[:category]),
                        {},
                        { class: "form-control" } %>
      </div>

      <div class="form-group">
        <%= form.label :start_date, "From Date", class: "form-label" %>
        <%= form.date_field :start_date, value: params[:start_date], class: "form-control" %>
      </div>

      <div class="form-group">
        <%= form.label :end_date, "To Date", class: "form-label" %>
        <%= form.date_field :end_date, value: params[:end_date], class: "form-control" %>
      </div>
    </div>

    <div class="mt-4">
      <%= form.submit "Filter", class: "btn btn-primary" %>
      <%= link_to "Clear", photos_path, class: "btn btn-outline" %>
      <%= link_to "Gallery View", gallery_photos_path, class: "btn btn-outline ml-2" %>
    </div>
  <% end %>
</div>

<!-- Gallery view -->
<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
  <% @photos.each do |photo| %>
    <div class="card overflow-hidden">
      <% if photo.image.attached? && photo.medium_image_url.present? %>
        <% safe_title = photo.title&.to_s&.gsub('"', '&quot;')&.gsub("'", '&#39;') || 'Photo' %>
        <%= image_tag photo.medium_image_url, class: "w-full h-48 object-cover", alt: safe_title %>
      <% else %>
        <div class="bg-gray-200 border-2 border-dashed rounded-xl w-full h-48 flex items-center justify-center">
          <span class="text-gray-500">No Image</span>
        </div>
      <% end %>

      <div class="p-4">
        <h3 class="font-semibold text-lg truncate"><%= photo.title %></h3>
        <p class="text-sm text-gray-600 mt-1"><%= photo.student.full_name %></p>
        <p class="text-xs text-gray-500 mt-1"><%= photo.created_at.strftime("%B %d, %Y") %></p>

        <% if photo.description.present? %>
          <p class="text-sm mt-2 truncate"><%= photo.description %></p>
        <% end %>

        <div class="mt-3 flex justify-between items-center">
          <span class="text-xs px-2 py-1 rounded-full bg-gray-100">
            <%= photo.category&.humanize %>
          </span>

          <% if current_user.teacher? || current_user.admin? %>
            <%= link_to "View", photo, class: "btn btn-outline btn-sm" %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<% if @photos.empty? %>
  <div class="text-center py-12">
    <svg class="mx-auto purpose-icon text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
    </svg>
    <h3 class="mt-2 text-sm font-medium">No photos</h3>
    <p class="mt-1 text-sm text-gray-500">Get started by uploading your first photo.</p>
    <% if current_user.teacher? || current_user.admin? %>
      <div class="mt-6">
        <%= link_to "Upload Photo", new_photo_path, class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
<% end %>