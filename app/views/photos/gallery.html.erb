<% content_for :title, "Photo Gallery" %>

<div class="page-header">
  <div>
    <h1 class="page-header__title">Photo Gallery</h1>
    <p class="page-header__subtitle">Approved photos visible to your account.</p>
  </div>

  <div class="page-actions">
    <%= link_to "Manage", photos_path, class: "btn" %>
    <% if current_user.teacher? || current_user.admin? %>
      <%= link_to "Upload Photo", new_photo_path, class: "btn btn-primary" %>
    <% end %>
  </div>
</div>

<div class="card" style="margin-bottom:24px;">
  <%= form_with url: gallery_photos_path, method: :get, local: true do |form| %>
    <div class="form-grid">
      <div class="form-group">
        <%= form.label :student_id, "Student", class: "form-label" %>
        <%= form.select :student_id,
              options_from_collection_for_select(@accessible_students, :id, :full_name, params[:student_id]),
              { prompt: "All students" },
              { class: "form-control" } %>
      </div>

      <div class="form-group">
        <%= form.label :classroom_id, "Classroom", class: "form-label" %>
        <%= form.select :classroom_id,
              options_from_collection_for_select(@accessible_classrooms, :id, :name, params[:classroom_id]),
              { prompt: "All classrooms" },
              { class: "form-control" } %>
      </div>

      <div class="form-group">
        <%= form.label :category, "Category", class: "form-label" %>
        <%= form.select :category,
              options_for_select(
                [
                  ["All categories", ""],
                  ["Activity", "activity"],
                  ["Event", "event"],
                  ["Milestone", "milestone"],
                  ["Daily Life", "daily_life"]
                ],
                params[:category]
              ),
              {},
              { class: "form-control" } %>
      </div>
    </div>

    <div class="page-actions" style="justify-content:flex-end; margin-top: 10px;">
      <%= link_to "Clear", gallery_photos_path, class: "btn btn-ghost" %>
      <%= form.submit "Filter", class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<% if @photos.any? %>
  <div class="gallery-grid">
    <% @photos.each do |photo| %>
      <div class="gallery-card">
        <%= link_to photo_path(photo), style: "text-decoration:none;" do %>
          <div class="gallery-card__image-wrap">
            <% if photo.image.attached? %>
              <%= image_tag url_for(photo.image.variant(resize_to_fill: [520, 360])),
                            alt: photo.title.to_s,
                            class: "gallery-card__image" %>
            <% else %>
              <div class="gallery-card__image" style="display:flex; align-items:center; justify-content:center; background:var(--surface-2); color:var(--muted); font-weight:600;">
                No image
              </div>
            <% end %>
          </div>

          <div class="gallery-card__content">
            <div style="display:flex; justify-content:space-between; gap:10px; margin-bottom:4px;">
              <div class="gallery-card__title">
                <%= photo.title.presence || "Photo" %>
              </div>
              <% if photo.category.present? %>
                <span class="status-badge"><%= photo.category.humanize %></span>
              <% end %>
            </div>

            <div class="gallery-card__meta">
              <span><%= photo.student&.full_name || "â€”" %></span>
              <% if photo.created_at %>
                <span style="font-size:0.8rem;"><%= time_ago_in_words(photo.created_at) %> ago</span>
              <% end %>
            </div>

            <% if photo.description.present? %>
              <div class="form-help" style="margin-top:8px; line-height:1.4;">
                <%= photo.description.to_s.truncate(70) %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if defined?(paginate) && @photos.respond_to?(:current_page) %>
    <div style="margin-top:24px;">
      <%= paginate @photos %>
    </div>
  <% end %>
<% else %>
  <div class="card">
    <div class="form-help">No approved photos found.</div>
  </div>
<% end %>