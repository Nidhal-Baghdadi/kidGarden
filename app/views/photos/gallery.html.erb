<% content_for :title, "Photo Gallery" %>

<div class="page-header">
  <div>
    <h1 class="page-header__title">Photo Gallery</h1>
    <p class="page-header__subtitle">Approved photos visible to your account.</p>
  </div>

  <div class="page-actions">
    <%= link_to "Manage", photos_path, class: "btn" %>
    <% if current_user.teacher? || current_user.admin? %>
      <%= link_to "Upload Photo", new_photo_path, class: "btn btn-primary" %>
    <% end %>
  </div>
</div>

<div class="card" style="margin-bottom:14px;">
  <%= form_with url: gallery_photos_path, method: :get, local: true do |form| %>
    <div class="form-grid">
      <div class="form-group">
        <%= form.label :student_id, "Student", class: "form-label" %>
        <%= form.select :student_id,
              options_from_collection_for_select(@accessible_students, :id, :full_name, params[:student_id]),
              { prompt: "All students" },
              { class: "form-control" } %>
      </div>

      <div class="form-group">
        <%= form.label :classroom_id, "Classroom", class: "form-label" %>
        <%= form.select :classroom_id,
              options_from_collection_for_select(@accessible_classrooms, :id, :name, params[:classroom_id]),
              { prompt: "All classrooms" },
              { class: "form-control" } %>
      </div>

      <div class="form-group">
        <%= form.label :category, "Category", class: "form-label" %>
        <%= form.select :category,
              options_for_select(
                [
                  ["All categories", ""],
                  ["Activity", "activity"],
                  ["Event", "event"],
                  ["Milestone", "milestone"],
                  ["Daily Life", "daily_life"]
                ],
                params[:category]
              ),
              {},
              { class: "form-control" } %>
      </div>
    </div>

    <div class="page-actions" style="justify-content:flex-end; margin-top: 10px;">
      <%= link_to "Clear", gallery_photos_path, class: "btn btn-ghost" %>
      <%= form.submit "Filter", class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<% if @photos.any? %>
  <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 14px;">
    <% @photos.each do |photo| %>
      <div class="card" style="padding:0; overflow:hidden;">
        <%= link_to photo_path(photo), style: "text-decoration:none;" do %>
          <% if photo.image.attached? %>
            <%= image_tag url_for(photo.image.variant(resize_to_fill: [520, 360])),
                          alt: photo.title.to_s,
                          style: "width:100%; height:180px; object-fit:cover; display:block;" %>
          <% else %>
            <div class="readonly" style="height:180px; justify-content:center;">No image</div>
          <% end %>

          <div style="padding:12px;">
            <div style="display:flex; justify-content:space-between; gap:10px;">
              <div style="min-width:0;">
                <div style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                  <%= photo.title.presence || "Photo" %>
                </div>
                <div class="form-help" style="margin:4px 0 0 0;">
                  <%= photo.student&.full_name || "â€”" %>
                </div>
              </div>

              <% if photo.category.present? %>
                <span class="status-badge"><%= photo.category.humanize %></span>
              <% end %>
            </div>

            <% if photo.description.present? %>
              <div class="form-help" style="margin-top:8px;">
                <%= photo.description.to_s.truncate(90) %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if defined?(paginate) && @photos.respond_to?(:current_page) %>
    <div style="margin-top:14px;">
      <%= paginate @photos %>
    </div>
  <% end %>
<% else %>
  <div class="card">
    <div class="form-help">No approved photos found.</div>
  </div>
<% end %>
