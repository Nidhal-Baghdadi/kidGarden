<% content_for :title, "Educational Resources" %>

<div class="page-header">
  <div>
    <h1 class="page-header__title">Educational Resources</h1>
    <p class="page-header__subtitle">Worksheets, lesson plans, and classroom materials.</p>
  </div>

  <div class="page-actions">
    <% if current_user.admin? || current_user.teacher? %>
      <%= link_to "New Resource", new_resource_path, class: "btn btn-primary" %>
    <% end %>
  </div>
</div>

<div class="dashboard-split" style="margin-bottom:24px;">
  <!-- Filters Card -->
  <div class="card" style="padding: 20px;">
    <h3 style="font-size: 1rem; margin: 0 0 16px 0; font-weight: 800;">Search & Filter</h3>
    <%= form_with url: resources_path, method: :get, local: true do |f| %>
      <div style="display: grid; gap: 14px;">
        <div class="form-group" style="margin:0;">
          <%= f.label :q, "Search Keywords", class: "form-label" %>
          <%= f.text_field :q, value: params[:q], class: "form-control", placeholder: "Title, subject..." %>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group" style="margin:0;">
            <%= f.label :category, class: "form-label" %>
            <%= f.select :category, [["All Categories", ""], ["Worksheet", "worksheet"], ["Presentation", "presentation"], ["Video", "video"], ["Audio", "audio"], ["Document", "document"], ["Other", "other"]], {selected: params[:category]}, {class: "form-control"} %>
          </div>
          <div class="form-group" style="margin:0;">
            <%= f.label :classroom_id, "Classroom", class: "form-label" %>
            <%= f.select :classroom_id, [["All Classrooms", ""]] + Classroom.order(:name).map { |c| [c.name, c.id] }, {selected: params[:classroom_id]}, {class: "form-control"} %>
          </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 6px;">
          <%= f.submit "Apply Filters", class: "btn btn-primary", style: "flex:1;" %>
          <%= link_to "Reset", resources_path, class: "btn btn-ghost" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Resource Categories Chart -->
  <div class="stat-card">
    <div class="stat-card__label">Resource Types</div>
    <div style="height: 200px; position: relative;">
      <canvas id="resourceTypesChart"></canvas>
    </div>
  </div>
</div>

<div class="card">
  <% if @resources.any? %>
    <div id="resources-table"></div>
  <% else %>
    <div class="text-frame" style="width:100%; text-align:center;">
      No resources found matching your criteria.
    </div>
  <% end %>
</div>

<script>
  (function() {
    let chart = null;

    function initResources() {
      const tableEl = document.getElementById("resources-table");
      const canvas = document.getElementById("resourceTypesChart");

      if (!tableEl && !canvas) return;

      if (chart) chart.destroy();

      if (canvas) {
        // Aggregate categories for chart
        const cats = {};
        <% @resources.each do |r| %>
          cats["<%= r.category || 'other' %>"] = (cats["<%= r.category || 'other' %>"] || 0) + 1;
        <% end %>
        
        chart = new Chart(canvas.getContext('2d'), {
          type: 'polarArea',
          data: {
            labels: Object.keys(cats).map(c => c.charAt(0).toUpperCase() + c.slice(1)),
            datasets: [{
              data: Object.values(cats),
              backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } }
          }
        });
      }

      if (tableEl && !tableEl.classList.contains("tabulator")) {
        const data = [
          <% @resources.each do |r| %>
          {
            title: "<%= j r.title %>",
            category: "<%= j(r.category.present? ? r.category.humanize : '—') %>",
            subject: "<%= j(r.subject.presence || '—') %>",
            classroom: "<%= j(r.classroom&.name || 'All Classrooms') %>",
            author: "<%= j(r.user&.name || 'System') %>",
            date: "<%= r.created_at.strftime('%b %d, %Y') %>",
            view_link: "<%= resource_path(r) %>",
            edit_link: "<%= (current_user.admin? || current_user.id == r.user_id) ? edit_resource_path(r) : '' %>"
          },
          <% end %>
        ];

        new Tabulator(tableEl, {
          data: data,
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 15,
          columns: [
            { title: "Resource", field: "title", widthGrow: 1.5, formatter: "textarea" },
            { 
              title: "Category", field: "category",
              formatter: function(cell) {
                return `<span class='status-badge'>${cell.getValue()}</span>`;
              }
            },
            { title: "Subject", field: "subject" },
            { title: "Classroom", field: "classroom" },
            { title: "Date", field: "date", width: 120 },
            {
              title: "Actions", formatter: function(cell) {
                const d = cell.getData();
                let h = `<a href='${d.view_link}' class='btn btn-sm'>Open</a>`;
                if(d.edit_link) h += ` <a href='${d.edit_link}' class='btn btn-sm btn-ghost'>Edit</a>`;
                return h;
              }
            }
          ]
        });
      }
    }
    document.addEventListener("turbo:load", initResources);
  })();
</script>