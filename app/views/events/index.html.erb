<% content_for :title, "Events" %>

<div class="page-header">
  <div>
    <h1 class="page-header__title">Events</h1>
    <p class="page-header__subtitle">Manage school calendar and upcoming events.</p>
  </div>

  <div class="page-actions">
    <% if current_user.admin? || current_user.teacher? %>
      <%= link_to "New Event", new_event_path, class: "btn btn-primary" %>
    <% end %>
  </div>
</div>

<div class="card">
  <% if @events.any? %>
    <div id="events-table"></div>
  <% else %>
    <div style="padding:18px;">
      <div class="text-frame">No events found.</div>
      <% if current_user.admin? || current_user.teacher? %>
        <div style="margin-top:12px;">
          <%= link_to "Create Event", new_event_path, class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<script>
  (function() {
    function initEvents() {
      const tableEl = document.getElementById("events-table");
      if (!tableEl || tableEl.classList.contains("tabulator")) return;

      const data = [
        <% @events.each do |e| %>
        {
          title: "<%= e.title %>",
          start: "<%= e.start_time.strftime('%b %d, %Y %I:%M %p') %>",
          end: "<%= e.end_time.strftime('%b %d, %Y %I:%M %p') %>",
          location: "<%= e.location.presence || 'â€”' %>",
          description: "<%= e.description.to_s.truncate(50) %>",
          link: "<%= event_path(e) %>"
        },
        <% end %>
      ];

      new Tabulator(tableEl, {
        data: data,
        layout: "fitColumns",
        pagination: "local",
        paginationSize: 15,
        columns: [
          { title: "Event", field: "title", widthGrow: 1.5, formatter: "textarea" },
          { title: "Start", field: "start", width: 160 },
          { title: "End", field: "end", width: 160 },
          { title: "Location", field: "location" },
          { title: "Description", field: "description" },
          { 
            title: "Actions", formatter: function(cell) {
               return `<a href='${cell.getData().link}' class='btn btn-sm'>View</a>`;
            } 
          }
        ]
      });
    }
    document.addEventListener("turbo:load", initEvents);
  })();
</script>