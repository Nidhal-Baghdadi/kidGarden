<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">Invoices</h1>
    <%= link_to 'New Invoice', new_invoice_path, class: 'bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200' %>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <%= form_with url: invoices_path, method: :get, local: true, class: "grid grid-cols-1 md:grid-cols-4 gap-4" do |form| %>
      <div>
        <%= form.label :student_id, "Student", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :student_id, options_from_collection_for_select(Student.all, :id, :full_name, params[:student_id]), { include_blank: "All Students" }, { class: "w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
      </div>

      <div>
        <%= form.label :status, "Status", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :status, options_for_select([["Pending", "pending"], ["Paid", "paid"], ["Overdue", "overdue"], ["Cancelled", "cancelled"], ["Partially Paid", "partially_paid"]], params[:status]), { include_blank: "All Statuses" }, { class: "w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
      </div>

      <div>
        <%= form.label :month, "Month", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :month, options_for_select((1..12).map { |m| [Date::MONTHNAMES[m], m] }, params[:month].to_i), { include_blank: "Any Month" }, { class: "w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
      </div>

      <div>
        <%= form.label :year, "Year", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <% years = ((Date.current.year - 2)..(Date.current.year + 1)).to_a %>
        <%= form.select :year, options_for_select(years.map { |y| [y, y] }, params[:year].to_i), { include_blank: "Any Year" }, { class: "w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
      </div>

      <div class="md:col-span-4 flex space-x-2">
        <%= form.submit "Filter", class: "bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg cursor-pointer" %>
        <%= link_to "Clear", invoices_path, class: "bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg" %>
      </div>
    <% end %>
  </div>

  <!-- Invoices Table -->
  <div class="bg-white rounded-lg shadow-md overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice #</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parent</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month/Year</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @invoices.each do |invoice| %>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900"><%= invoice.invoice_number %></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900"><%= invoice.student.full_name %></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900"><%= invoice.parent.name %></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900"><%= Date.new(invoice.year, invoice.month, 1).strftime("%B %Y") %></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">$<%= number_with_precision(invoice.total_amount, precision: 2) %></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900"><%= invoice.due_date.strftime("%b %d, %Y") %></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                <% case invoice.status %>
                  <% when 'paid' %>
                    bg-green-100 text-green-800
                  <% when 'pending' %>
                    bg-yellow-100 text-yellow-800
                  <% when 'overdue' %>
                    bg-red-100 text-red-800
                  <% when 'cancelled' %>
                    bg-gray-100 text-gray-800
                  <% when 'partially_paid' %>
                    bg-blue-100 text-blue-800
                  <% else %>
                    bg-gray-100 text-gray-800
                <% end %>">
                <%= invoice.status_label %>
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <%= link_to 'View', invoice, class: 'text-blue-600 hover:text-blue-900 mr-2' %>
              <%= link_to 'Edit', edit_invoice_path(invoice), class: 'text-indigo-600 hover:text-indigo-900 mr-2' %>
              <%= link_to 'PDF', download_pdf_invoice_path(invoice), class: 'text-green-600 hover:text-green-900 mr-2', target: '_blank' %>
              <%= link_to 'Delete', invoice, method: :delete, 
                          confirm: 'Are you sure?', 
                          class: 'text-red-600 hover:text-red-900' %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <% if @invoices.empty? %>
      <div class="text-center py-8">
        <p class="text-gray-500">No invoices found.</p>
        <%= link_to 'Create a new invoice', new_invoice_path, class: 'text-blue-600 hover:underline mt-2 inline-block' %>
      </div>
    <% end %>
  </div>
</div>