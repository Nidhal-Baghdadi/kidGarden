<% content_for :title, "Dashboard" %>

<div class="page-header">
  <div>
    <div style="font-size:0.95rem; color:var(--muted); font-weight:700; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:4px;">Welcome back</div>
    <div style="font-size:2rem; font-weight:800; letter-spacing:-0.02em; color:var(--text);"><%= current_user.name %></div>
  </div>
  <div class="page-actions">
    <%= link_to "Students", students_path, class: "btn" %>
    <%= link_to "Attendance", attendances_path, class: "btn btn-primary" %>
  </div>
</div>

<div class="dashboard-grid">
  <div class="stat-card">
    <div class="stat-card__label">Total Students</div>
    <div class="stat-card__value"><%= Student.count %></div>
    <div class="stat-card__meta">Enrolled: <%= Student.where(status: 'enrolled').count %></div>
  </div>

  <div class="stat-card">
    <div class="stat-card__label">Active Classrooms</div>
    <div class="stat-card__value"><%= Classroom.count %></div>
    <div class="stat-card__meta">Teachers: <%= User.where(role: 'teacher').count %></div>
  </div>

  <!-- Chart Card 1 -->
  <div class="stat-card" style="grid-column: span 1;">
    <div class="stat-card__label">Today's Attendance</div>
    <div style="position: relative; height: 160px; width: 100%;">
      <canvas id="attendanceChart"></canvas>
    </div>
  </div>

  <!-- Chart Card 2 -->
  <div class="stat-card" style="grid-column: span 1;">
    <div class="stat-card__label">Outstanding Fees</div>
    <div style="position: relative; height: 160px; width: 100%;">
      <canvas id="feesChart"></canvas>
    </div>
  </div>
</div>

<div class="dashboard-split">
  <!-- Recent Students Table -->
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <div style="font-weight:800; font-size:1.1rem;">Recent Students</div>
      <%= link_to "View all", students_path, class: "btn btn-sm btn-ghost" %>
    </div>
    
    <% if @recent_students.any? %>
      <div id="recent-students-table"></div>
    <% else %>
      <div class="text-frame">No students found.</div>
    <% end %>
  </div>

  <!-- Upcoming Events Table -->
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <div style="font-weight:800; font-size:1.1rem;">Upcoming Events</div>
      <%= link_to "View all", events_path, class: "btn btn-sm btn-ghost" %>
    </div>

    <% upcoming_events = Event.where('start_time > ?', DateTime.current).order(:start_time).limit(5) %>
    <% if upcoming_events.any? %>
      <div id="upcoming-events-table"></div>
    <% else %>
      <div class="text-frame">No upcoming events.</div>
    <% end %>
  </div>
</div>

<!-- Initialization Script -->
<script>
  (function() {
    let attendanceChart = null;
    let feesChart = null;

    function initDashboard() {
      // --- Charts ---
      
      const attendanceCanvas = document.getElementById('attendanceChart');
      const feesCanvas = document.getElementById('feesChart');

      // Only run if elements exist (we are on dashboard)
      if (!attendanceCanvas || !feesCanvas) return;

      // Destroy existing instances to prevent memory leaks/glitches on navigation
      if (attendanceChart) attendanceChart.destroy();
      if (feesChart) feesChart.destroy();

      // 1. Attendance Doughnut Chart
      const presentCount = <%= Attendance.where(date: Date.current, status: 'present').count %>;
      const absentCount = <%= Attendance.where(date: Date.current, status: 'absent').count %>;
      const dataPresent = presentCount || 0; 
      const dataAbsent = absentCount || 0;
      const dataNone = (dataPresent + dataAbsent === 0) ? 1 : 0; 

      attendanceChart = new Chart(attendanceCanvas.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['Present', 'Absent', 'No Data'],
          datasets: [{
            data: [dataPresent, dataAbsent, dataNone],
            backgroundColor: ['#10B981', '#EF4444', '#E5E7EB'],
            borderWidth: 0,
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'right',
              labels: {
                boxWidth: 12,
                usePointStyle: true,
                font: { family: "'Nunito', sans-serif", size: 11 }
              }
            }
          },
          cutout: '70%'
        }
      });

      // 2. Fees Status Chart (Bar)
      const pendingFees = <%= Fee.where(status: 'pending').count %>;
      const overdueFees = <%= Fee.where(status: 'overdue').count %>;
      const paidFees = <%= Fee.where(status: 'paid').count %>;

      feesChart = new Chart(feesCanvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: ['Paid', 'Pending', 'Overdue'],
          datasets: [{
            label: 'Fees',
            data: [paidFees, pendingFees, overdueFees],
            backgroundColor: ['#10B981', '#F59E0B', '#EF4444'],
            borderRadius: 4,
            barThickness: 20
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, display: false },
            x: { grid: { display: false }, ticks: { font: { size: 10 } } }
          },
          plugins: { legend: { display: false } }
        }
      });

      // --- Tabulator Tables ---

      // 1. Recent Students
      const studentsTableEl = document.getElementById("recent-students-table");
      if (studentsTableEl && !studentsTableEl.classList.contains("tabulator")) {
        <% if @recent_students.any? %>
        const studentsData = [
          <% @recent_students.each do |s| %>
          { 
            name: "<%= s.first_name %> <%= s.last_name %>", 
            classroom: "<%= s.classroom&.name || 'Unassigned' %>", 
            status: "<%= (s.status || 'Unknown').humanize %>",
            link: "<%= student_path(s) %>"
          },
          <% end %>
        ];

        new Tabulator(studentsTableEl, {
          data: studentsData,
          layout: "fitColumns",
          height: "300px",
          columns: [
            { title: "Student Name", field: "name", widthGrow: 2 },
            { title: "Classroom", field: "classroom" },
            { 
              title: "Status", 
              field: "status",
              formatter: function(cell) {
                const val = cell.getValue();
                let colorClass = "status-inactive";
                if(val === "Enrolled") colorClass = "status-enrolled";
                return `<span class='status-badge ${colorClass}'>${val}</span>`;
              }
            }
          ],
          rowClick:function(e, row){
            // Navigate on row click
             window.location.href = row.getData().link;
          }
        });
        <% end %>
      }

      // 2. Upcoming Events
      const eventsTableEl = document.getElementById("upcoming-events-table");
      if (eventsTableEl && !eventsTableEl.classList.contains("tabulator")) {
        <% if upcoming_events.any? %>
        const eventsData = [
          <% upcoming_events.each do |e| %>
          {
            title: "<%= e.title %>",
            date: "<%= e.start_time.strftime('%b %d') %>",
            time: "<%= e.start_time.strftime('%I:%M %p') %>",
            location: "<%= e.location.presence || 'â€”' %>",
            link: "<%= event_path(e) %>"
          },
          <% end %>
        ];

        new Tabulator(eventsTableEl, {
          data: eventsData,
          layout: "fitColumns",
          height: "300px",
          columns: [
            { title: "Event", field: "title", widthGrow: 2, formatter: "textarea" },
            { title: "Date", field: "date", width: 80 },
            { title: "Time", field: "time", width: 100 },
            { title: "Location", field: "location" }
          ],
          rowClick:function(e, row){
             window.location.href = row.getData().link;
          }
        });
        <% end %>
      }
    }

    // Initialize on both Turbo Load (navigation) and DOMContentLoaded (hard refresh)
    document.addEventListener("turbo:load", initDashboard);
    // document.addEventListener("DOMContentLoaded", initDashboard); // turbo:load usually handles this too in Rails 7+
  })();
</script>